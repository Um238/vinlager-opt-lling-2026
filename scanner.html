<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Vinlager Scanner</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      margin: 0; padding: 0; background: #000; overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      position: fixed; width: 100%; height: 100%; font-size: 20px;
    }
    .scanner-container {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; flex-direction: column; background: #000;
    }
    .scanner-header {
      position: relative; background: #4CAF50; color: white;
      padding: 10px 75px 10px 12px; z-index: 10; flex-shrink: 0;
    }
    .scanner-close-btn {
      position: absolute; top: 6px; right: 6px;
      background: rgba(255,255,255,0.95); color: #4CAF50;
      border: none; padding: 8px 14px; border-radius: 12px;
      font-weight: 700; font-size: 1em; cursor: pointer;
      z-index: 20; text-decoration: none; display: block;
    }
    .scanner-header h1 {
      margin: 0; font-size: 1.3em; font-weight: 600;
    }
    .location-selector {
      margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.95);
      border-radius: 6px; display: flex; align-items: center; gap: 8px;
    }
    .location-selector label {
      font-weight: 600; color: #333; font-size: 0.85em; white-space: nowrap;
    }
    .location-selector select {
      flex: 1; padding: 8px; font-size: 0.9em; border: 2px solid #4CAF50;
      border-radius: 6px; background: white; color: #333;
    }
    .video-container {
      flex: 1; position: relative; overflow: hidden; background: #000;
    }
    #qr-video {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }
    .scan-overlay {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: min(50vw, 200px); height: min(50vw, 200px);
      border: 3px solid #4CAF50; border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }
    .bottom-controls {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.8); padding: 15px; z-index: 20;
    }
    .finish-btn {
      width: 100%; padding: 20px; font-size: 1.5em;
      background: #4CAF50; color: white; border: none;
      border-radius: 12px; font-weight: 700; cursor: pointer;
    }
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 1000;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
      background: white; border-radius: 16px; padding: 24px;
      max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;
    }
    .modal-title { font-size: 1.8em; font-weight: 700; margin-bottom: 15px; }
    .modal-warning {
      background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;
      padding: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
    }
    .modal-info { margin-bottom: 15px; font-size: 1.1em; }
    .modal-input-group { margin-bottom: 20px; }
    .modal-input-group label {
      display: block; font-weight: 600; margin-bottom: 8px; font-size: 1.1em;
    }
    .modal-input-group input {
      width: 100%; padding: 20px; font-size: 1.8em; text-align: center;
      border: 3px solid #4CAF50; border-radius: 12px; font-weight: 600;
    }
    .modal-buttons { display: flex; gap: 10px; }
    .btn-cancel, .btn-save-modal {
      flex: 1; padding: 18px; font-size: 1.4em; border: none;
      border-radius: 12px; font-weight: 600; cursor: pointer;
    }
    .btn-cancel { background: #6c757d; color: white; }
    .btn-save-modal { background: #4CAF50; color: white; }
  </style>
</head>
<body>
  <div class="scanner-container">
    <div class="scanner-header">
      <a href="index.html" class="scanner-close-btn" onclick="window.closeScanner(); return false;">‚úï Luk</a>
      <h1>üç∑ Vinlager Scanner</h1>
      <div class="location-selector">
        <label for="location-select">üìç Lokation:</label>
        <select id="location-select">
          <option value="">Alle lokationer</option>
        </select>
      </div>
    </div>
    <div class="video-container">
      <video id="qr-video" autoplay playsinline muted></video>
      <canvas id="qr-canvas" style="display: none;"></canvas>
      <div class="scan-overlay"></div>
    </div>
    <div class="bottom-controls">
      <button class="finish-btn" onclick="finishCounting()">‚úÖ Afslut opt√¶lling</button>
    </div>
  </div>

  <div class="modal-overlay" id="quantity-modal">
    <div class="modal-content">
      <h2 class="modal-title" id="modal-title">Indtast antal</h2>
      <div id="modal-warning" class="modal-warning" style="display: none;">
        <span>‚ö†Ô∏è</span>
        <span id="modal-warning-text">Vare ikke fundet</span>
      </div>
      <div class="modal-info" id="modal-info"></div>
      <div class="modal-input-group">
        <label for="quantity-input">Antal:</label>
        <input type="number" id="quantity-input" min="0" value="1" autofocus>
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal()">Annuller</button>
        <button class="btn-save-modal" onclick="saveQuantity()">Gem</button>
      </div>
    </div>
  </div>

  <script src="config.js?v=39"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    // GLOBALE VARIABLER
    let qrStream = null;
    let qrScanning = false;
    let currentWine = null;
    let scannedWines = new Map();
    let scanAnimationFrame = null;
    let locations = [];
    let selectedLocationId = null;
    let locationsLoaded = false; // Track om lokationer er hentet
    let lastScannedCode = null; // Debounce: sidste scannede kode
    let lastScanTime = 0; // Debounce: tidspunkt for sidste scan

    // LUK SCANNER - ALTID VIRKER
    window.closeScanner = function() {
      try {
        qrScanning = false;
        if (scanAnimationFrame) {
          cancelAnimationFrame(scanAnimationFrame);
          scanAnimationFrame = null;
        }
        if (qrStream) {
          qrStream.getTracks().forEach(t => t.stop());
          qrStream = null;
        }
      } catch (e) {}
      window.location.href = 'index.html';
    };

    // CONFIG
    function getConfig() {
      if (window.CONFIG) return window.CONFIG;
      if (typeof CONFIG !== 'undefined') {
        window.CONFIG = CONFIG;
        return CONFIG;
      }
      return {
        API_URL: 'https://vinlager-opt-lling-2026.onrender.com',
        TIMEOUT: 60000
      };
    }

    function toLocalDateTimeString() {
      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // API CALL
    async function apiCall(endpoint, options = {}) {
      const config = getConfig();
      const url = `${config.API_URL}${endpoint}`;
      const ac = new AbortController();
      const tid = setTimeout(() => ac.abort(), config.TIMEOUT || 60000);
      
      console.log(`üåê API kald: ${options.method || 'GET'} ${url}`);
      if (options.body) {
        console.log(`üì¶ Request body:`, options.body);
      }
      
      try {
        const response = await fetch(url, {
          ...options,
          signal: ac.signal,
          headers: { 'Content-Type': 'application/json', ...(options.headers || {}) }
        });
        clearTimeout(tid);
        
        console.log(`üì• Response status: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error(`‚ùå API fejl ${response.status}:`, errorText);
          throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
        }
        
        const data = await response.json();
        console.log(`‚úÖ API success:`, data);
        return data;
      } catch (e) {
        clearTimeout(tid);
        console.error(`‚ùå API exception:`, e.message);
        throw e;
      }
    }

    // STATUS - FJERNET - ingen status-besked der forstyrrer

    // HENT LOKATIONER
    async function loadLocations() {
      const select = document.getElementById('location-select');
      if (!select) return;
      
      select.innerHTML = '<option value="">Alle lokationer</option>';
      selectedLocationId = null;
      
      select.onchange = (e) => {
        selectedLocationId = e.target.value ? parseInt(e.target.value) : null;
        console.log('üìç Lokation valgt:', selectedLocationId, e.target.value ? locations.find(l => l.id === selectedLocationId)?.name : 'Alle lokationer');
      };
      
      setTimeout(async () => {
        try {
          const config = getConfig();
          const response = await fetch(`${config.API_URL}/api/locations`);
          if (!response.ok) return;
          const data = await response.json();
          if (!Array.isArray(data) || data.length === 0) return;
          
          locations = data;
          select.innerHTML = '<option value="">Alle lokationer</option>';
          data.forEach(loc => {
            const o = document.createElement('option');
            o.value = loc.id;
            o.textContent = loc.name;
            select.appendChild(o);
          });
             // Fjernet status-besked for at undg√• forstyrrelse
        } catch (e) {}
      }, 1000);
    }

    // START SCANNER - VENT P√Ö LOKATIONER
    function startQRScannerWhenReady() {
      // Vent p√• at lokationer er hentet
      if (!locationsLoaded) {
        console.log('‚è≥ Venter p√• at lokationer er hentet...');
        setTimeout(() => startQRScannerWhenReady(), 500);
        return;
      }
      
      // Vent ogs√• p√• at jsQR biblioteket er indl√¶st
      if (typeof jsQR === 'undefined') {
        console.log('‚è≥ Venter p√• jsQR bibliotek...');
        setTimeout(() => startQRScannerWhenReady(), 500);
        return;
      }
      
      // Nu kan vi starte scanneren
      console.log('‚úÖ Starter scanner - lokationer og bibliotek er klar');
      startQRScanner();
    }
    
    // START SCANNER
    async function startQRScanner() {
      if (qrScanning) {
        console.log('‚ö†Ô∏è Scanner k√∏rer allerede');
        return;
      }
      
      const video = document.getElementById('qr-video');
      const canvas = document.getElementById('qr-canvas');
      if (!video || !canvas) {
        console.error('‚ùå Video eller canvas element ikke fundet');
        return;
      }
      
      try {
        console.log('üìπ Anmoder om kamera adgang...');
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        
        qrStream = stream;
        video.srcObject = stream;
        qrScanning = true;
        
        video.onloadedmetadata = () => {
          video.play();
          console.log('‚úÖ Kamera startet');
        };
        video.play();
        
        // Vent lidt f√∏r vi starter scanning (undg√• falske QR-koder fra st√∏j)
        setTimeout(() => {
          scanFrame();
        }, 1000); // Vent 1 sekund efter kamera starter
        
      } catch (error) {
        qrScanning = false;
        console.error('‚ùå Kamera fejl:', error.message);
        alert('Kunne ikke f√• adgang til kamera. Tjek om kameraet er aktiveret.');
      }
    }
    
    // SCAN FRAME - MED DEBOUNCE OG VALIDERING
    function scanFrame() {
      if (!qrScanning || !video) return;
      
      if (video.readyState !== video.HAVE_ENOUGH_DATA) {
        scanAnimationFrame = requestAnimationFrame(scanFrame);
        return;
      }
      
      try {
        const width = video.videoWidth;
        const height = video.videoHeight;
        if (!width || !height) {
          scanAnimationFrame = requestAnimationFrame(scanFrame);
          return;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, width, height);
        const imageData = ctx.getImageData(0, 0, width, height);
        
        if (typeof jsQR !== 'undefined') {
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code && code.data && code.data.trim()) {
            const codeData = code.data.trim();
            
            // VALIDERING: Tjek om QR-koden ser gyldig ud
            // Accepter b√•de VIN-XXXX format og WXXX format (varenummer)
            const isValidFormat = /^(VIN-|W\d+|vin-|w\d+)/i.test(codeData);
            
            if (!isValidFormat) {
              // Ignorer falske QR-koder fra st√∏j
              scanAnimationFrame = requestAnimationFrame(scanFrame);
              return;
            }
            
            // DEBOUNCE: Ignorer samme kode hvis den scannes for hurtigt (inden for 2 sekunder)
            const now = Date.now();
            if (codeData === lastScannedCode && (now - lastScanTime) < 2000) {
              // Samme kode scannet for hurtigt - ignorer
              scanAnimationFrame = requestAnimationFrame(scanFrame);
              return;
            }
            
            // Ny kode eller nok tid er g√•et - behandle scan
            lastScannedCode = codeData;
            lastScanTime = now;
            console.log('üì∑ QR-kode scannet:', codeData);
            handleScan(codeData);
            
            // Stop scanning kortvarigt for at undg√• gentagne scans
            qrScanning = false;
            setTimeout(() => {
              if (video && video.srcObject) {
                qrScanning = true;
                scanFrame();
              }
            }, 2000); // Vent 2 sekunder f√∏r vi scanner igen
            return;
          }
        }
      } catch (err) {
        console.error('‚ùå Scan fejl:', err);
      }
      
      if (qrScanning) {
        scanAnimationFrame = requestAnimationFrame(scanFrame);
      }
    }

    // H√ÖNDTER SCAN
    async function handleScan(codeData) {
      if (!codeData || !codeData.trim()) return;
      const modal = document.getElementById('quantity-modal');
      if (modal && modal.classList.contains('show')) return;
      
      try {
        currentWine = await apiCall(`/api/wines/${encodeURIComponent(codeData.trim())}`);
        showQuantityModal(currentWine, false);
      } catch (error) {
        showQuantityModal({ vinId: codeData.trim(), navn: 'Ukendt vare' }, true);
      }
    }

    // VIS MODAL
    function showQuantityModal(wine, notFound) {
      const modal = document.getElementById('quantity-modal');
      const title = document.getElementById('modal-title');
      const warning = document.getElementById('modal-warning');
      const info = document.getElementById('modal-info');
      const input = document.getElementById('quantity-input');
      
      currentWine = wine;
      
      if (notFound) {
        title.textContent = 'Indtast antal';
        warning.style.display = 'flex';
        info.innerHTML = `<div><strong>Stregkode:</strong> ${wine.vinId}</div>`;
        input.value = '1';
      } else {
        title.textContent = wine.navn || 'Indtast antal';
        warning.style.display = 'none';
        const locName = selectedLocationId ? locations.find(l => l.id === selectedLocationId)?.name : 'Ikke valgt';
        info.innerHTML = `
          <div><strong>VIN-ID:</strong> ${wine.vinId}</div>
          <div><strong>Lokation:</strong> ${locName}</div>
          <div><strong>Nuv√¶rende:</strong> ${wine.antal || 0}</div>
        `;
        input.value = wine.antal || '1';
      }
      
      modal.classList.add('show');
      input.focus();
      input.select();
    }

    function closeModal() {
      const modal = document.getElementById('quantity-modal');
      modal.classList.remove('show');
      currentWine = null;
    }

    // GEM ANTAL
    async function saveQuantity() {
      const input = document.getElementById('quantity-input');
      const quantity = parseInt(input.value) || 0;
      
      if (!currentWine || !currentWine.vinId) {
        alert('Ingen vin valgt!');
        closeModal();
        return;
      }
      
      console.log(`üíæ Gemmer antal for ${currentWine.vinId}: ${quantity}`);
      
      try {
        // KRITISK FIX: GEM ALTID data til backend, uanset om vinen findes eller ej
        if (currentWine.vinId) {
          try {
            // KRITISK FIX: Hvis ingen lokation er valgt, brug f√∏rste tilg√¶ngelige lokation
            let finalLocationId = selectedLocationId ? parseInt(selectedLocationId) : null;
            if (!finalLocationId && locations.length > 0) {
              finalLocationId = locations[0].id;
              console.log(`‚ö†Ô∏è Ingen lokation valgt, bruger f√∏rste tilg√¶ngelige: ${finalLocationId} (${locations[0].name})`);
            }
            
            const requestBody = {
              nytAntal: quantity,
              locationId: finalLocationId
            };
            
            console.log(`üì§ Sender til backend: /api/count/${currentWine.vinId}`, requestBody);
            
            // KRITISK FIX: Send nytAntal som tal, ikke string
            const response = await apiCall(`/api/count/${currentWine.vinId}`, {
              method: 'POST',
              body: JSON.stringify(requestBody)
            });
            
            console.log('‚úÖ Backend respons:', response);
            
            // Opdater currentWine med det nye antal fra backend
            if (response && response.nytAntal !== undefined) {
              currentWine.antal = response.nytAntal;
              console.log(`‚úÖ Antal opdateret i backend til: ${response.nytAntal}`);
            } else {
              // Hvis backend ikke returnerer nytAntal, brug det vi sendte
              currentWine.antal = quantity;
              console.log(`‚úÖ Brugt sendt antal: ${quantity}`);
            }
          } catch (apiError) {
            console.error('‚ùå Fejl ved API kald:', apiError);
            console.error('‚ùå Fejl detaljer:', apiError.message, apiError.stack);
            // Hvis API fejler, gem stadig lokalt for rapporten
            console.warn('‚ö†Ô∏è API fejlede, gemmer lokalt for rapporten');
            currentWine.antal = quantity;
            // Vis ikke alert - forstyrrer scanning
          }
        }
        
        // Brug samme locationId som blev sendt til backend
        const finalLocationId = selectedLocationId ? parseInt(selectedLocationId) : (locations.length > 0 ? locations[0].id : null);
        const locName = finalLocationId ? locations.find(l => l.id === finalLocationId)?.name : 'Ikke valgt';
        scannedWines.set(currentWine.vinId, {
          ...currentWine,
          antal: currentWine.antal || quantity,
          locationId: finalLocationId,
          locationName: locName
        });
        
        console.log(`‚úÖ Gemt i scannedWines: ${currentWine.vinId}, antal: ${currentWine.antal || quantity}, total scannet: ${scannedWines.size}`);
        
        // Ingen status-besked - forstyrrer scanning
        closeModal();
      } catch (error) {
        console.error('‚ùå KRITISK FEJL ved gemning af antal:', error);
        console.error('‚ùå Fejl stack:', error.stack);
        alert(`Fejl: ${error.message}`);
      }
    }

    // AFSLUT OPT√ÜLLING
    async function finishCounting() {
      if (scannedWines.size === 0) {
        if (!confirm('Ingen vine scannet. Afslutte?')) return;
      } else {
        const locName = selectedLocationId ? locations.find(l => l.id === selectedLocationId)?.name : 'Ikke valgt';
        if (!confirm(`${scannedWines.size} vine scannet. Lokation: ${locName}. Afslutte?`)) return;
      }
      
      try {
        // Ingen status-besked - forstyrrer ikke
        
        if (qrStream) {
          qrStream.getTracks().forEach(t => t.stop());
          qrStream = null;
        }
        qrScanning = false;
        
        const wines = Array.from(scannedWines.values());
        if (wines.length === 0) {
          alert('Ingen vine scannet.');
          return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;
        doc.setFontSize(16);
        doc.text('Opt√¶llingsrapport', 14, y);
        y += 10;
        
        const winesByLocation = {};
        wines.forEach(w => {
          const loc = w.locationName || 'Ikke valgt';
          if (!winesByLocation[loc]) winesByLocation[loc] = [];
          winesByLocation[loc].push(w);
        });
        
        let grandTotal = 0;
        let grandCount = 0;
        
        Object.keys(winesByLocation).sort().forEach(loc => {
          if (y > 250) { doc.addPage(); y = 20; }
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text(`Lokation: ${loc}`, 14, y);
          y += 8;
          
          doc.setFontSize(8);
          doc.setFont(undefined, 'normal');
          winesByLocation[loc].forEach(w => {
            if (y > 280) { doc.addPage(); y = 20; }
            const pris = w.indk√∏bspris || 0;
            const v√¶rdi = pris * (w.antal || 0);
            grandTotal += v√¶rdi;
            grandCount++;
            doc.setFont(undefined, 'bold');
            const varenummer = w.varenummer || w.vinId || '';
            doc.text(`* ${varenummer} | ${w.navn || ''} | ${w.antal || 0} | ${pris.toFixed(2)} kr`, 14, y);
            doc.setFont(undefined, 'normal');
            y += 6;
          });
          y += 5;
        });
        
        if (y > 270) { doc.addPage(); y = 20; }
        y += 5;
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(`SAMLET TOTAL: ${grandCount} vine, ${grandTotal.toFixed(2)} kr.`, 14, y);
        
        const locName = selectedLocationId ? locations.find(l => l.id === selectedLocationId)?.name : 'Alle lokationer';
        const reportData = {
          reportId: Date.now().toString(),
          date: toLocalDateTimeString(),
          name: 'OPT√ÜLLING-' + Date.now().toString().slice(-6),
          type: 'lager',
          wineCount: grandCount,
          totalValue: grandTotal,
          location: locName,
          archived: false
        };
        
        try {
          await apiCall('/api/reports/save', {
            method: 'POST',
            body: JSON.stringify(reportData)
          });
        } catch (e) {
          alert('Rapport kunne ikke gemmes i backend.');
        }
        
        doc.save('lagerrapport_opt√¶lling.pdf');
          // Rapport genereret - vises i alert
        
        setTimeout(() => {
          alert(`Opt√¶lling afsluttet! ${grandCount} vine, ${grandTotal.toFixed(2)} kr.`);
          window.location.href = 'index.html';
        }, 1000);
      } catch (error) {
        console.error('Fejl:', error.message);
      }
    }

    // START ALT
    function start() {
      console.log('üöÄ Starter scanner applikation...');
      // Hent lokationer f√∏rst - scanneren starter automatisk n√•r de er klar
      loadLocations();
      
      const input = document.getElementById('quantity-input');
      if (input) {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') saveQuantity();
        });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', start);
    } else {
      start();
    }
  </script>
</body>
</html>
