<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Vinlager Scanner</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      margin: 0; padding: 0; background: #000; overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      position: fixed; width: 100%; height: 100%; font-size: 20px;
    }
    .scanner-container {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; flex-direction: column; background: #000;
    }
    .scanner-header {
      position: relative; background: #4CAF50; color: white;
      padding: 10px 75px 10px 12px; z-index: 10; flex-shrink: 0;
    }
    .scanner-close-btn {
      position: absolute; top: 6px; right: 6px;
      background: rgba(255,255,255,0.95); color: #4CAF50;
      border: none; padding: 8px 14px; border-radius: 12px;
      font-weight: 700; font-size: 1em; cursor: pointer;
      z-index: 20; text-decoration: none; display: block;
    }
    .scanner-header h1 {
      margin: 0; font-size: 1.3em; font-weight: 600;
    }
    .location-selector {
      margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.95);
      border-radius: 6px; display: flex; align-items: center; gap: 8px;
    }
    .location-selector label {
      font-weight: 600; color: #333; font-size: 0.85em; white-space: nowrap;
    }
    .location-selector select {
      flex: 1; padding: 8px; font-size: 0.9em; border: 2px solid #4CAF50;
      border-radius: 6px; background: white; color: #333;
    }
    .video-container {
      flex: 1; position: relative; overflow: hidden; background: #000;
    }
    #qr-video {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }
    .scan-overlay {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: min(50vw, 200px); height: min(50vw, 200px);
      border: 3px solid #4CAF50; border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }
    .bottom-controls {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.8); padding: 15px; z-index: 20;
    }
    .finish-btn {
      width: 100%; padding: 20px; font-size: 1.5em;
      background: #4CAF50; color: white; border: none;
      border-radius: 12px; font-weight: 700; cursor: pointer;
    }
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 1000;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
      background: white; border-radius: 16px; padding: 24px;
      max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;
    }
    .modal-title { font-size: 1.8em; font-weight: 700; margin-bottom: 15px; }
    .modal-warning {
      background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;
      padding: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
    }
    .modal-info { margin-bottom: 15px; font-size: 1.1em; }
    .modal-input-group { margin-bottom: 20px; }
    .modal-input-group label {
      display: block; font-weight: 600; margin-bottom: 8px; font-size: 1.1em;
    }
    .modal-input-group input {
      width: 100%; padding: 20px; font-size: 1.8em; text-align: center;
      border: 3px solid #4CAF50; border-radius: 12px; font-weight: 600;
    }
    .modal-buttons { display: flex; gap: 10px; }
    .btn-cancel, .btn-save-modal {
      flex: 1; padding: 18px; font-size: 1.4em; border: none;
      border-radius: 12px; font-weight: 600; cursor: pointer;
    }
    .btn-cancel { background: #6c757d; color: white; }
    .btn-save-modal { background: #4CAF50; color: white; }
    .status-message {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9); color: white; padding: 20px 30px;
      border-radius: 12px; z-index: 2000; text-align: center;
      font-size: 1.2em; max-width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .status-message.error { background: rgba(200, 0, 0, 0.9); }
    .status-message.success { background: rgba(0, 150, 0, 0.9); }
    .status-message.warning { background: rgba(255, 165, 0, 0.9); }
  </style>
</head>
<body>
  <div class="scanner-container">
    <div class="scanner-header">
      <a href="index.html" class="scanner-close-btn" onclick="window.closeScanner(); return false;">‚úï Luk</a>
      <h1>üç∑ Vinlager Scanner</h1>
      <div class="location-selector">
        <label for="location-select">üìç Lokation:</label>
        <select id="location-select">
          <option value="">Alle lokationer</option>
        </select>
      </div>
    </div>
    <div class="video-container">
      <video id="qr-video" autoplay playsinline muted></video>
      <canvas id="qr-canvas" style="display: none;"></canvas>
      <div class="scan-overlay"></div>
      <div id="status-message" class="status-message" style="display: none;"></div>
    </div>
    <div class="bottom-controls">
      <button class="finish-btn" onclick="finishCounting()">‚úÖ Afslut opt√¶lling</button>
    </div>
  </div>

  <div class="modal-overlay" id="quantity-modal">
    <div class="modal-content">
      <h2 class="modal-title" id="modal-title">Indtast antal</h2>
      <div id="modal-warning" class="modal-warning" style="display: none;">
        <span>‚ö†Ô∏è</span>
        <span id="modal-warning-text">Vare ikke fundet</span>
      </div>
      <div class="modal-info" id="modal-info"></div>
      <div class="modal-input-group">
        <label for="quantity-input">Antal:</label>
        <input type="number" id="quantity-input" min="0" value="1" autofocus>
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal()">Annuller</button>
        <button class="btn-save-modal" onclick="saveQuantity()">Gem</button>
      </div>
    </div>
  </div>

  <script src="config.js?v=40"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    // GLOBALE VARIABLER
    let qrStream = null;
    let qrScanning = false;
    let currentWine = null;
    let scanAnimationFrame = null; // FJERNET DUPLIKAT
    let scannedWines = new Map();
    let locations = [];
    let selectedLocationId = null;
    let locationsLoaded = false; // Track om lokationer er hentet
    let lastScannedCode = null; // Debounce: sidste scannede kode
    let lastScanTime = 0; // Debounce: tidspunkt for sidste scan
    let video = null; // Cache video element
    let canvas = null; // Cache canvas element
    
    // VIS STATUS BESKED P√Ö SK√ÜRMEN
    function showStatus(message, type = 'info', duration = 3000) {
      const statusEl = document.getElementById('status-message');
      if (!statusEl) return;
      
      statusEl.textContent = message;
      statusEl.className = `status-message ${type}`;
      statusEl.style.display = 'block';
      
      if (duration > 0) {
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, duration);
      }
    }
    
    function hideStatus() {
      const statusEl = document.getElementById('status-message');
      if (statusEl) statusEl.style.display = 'none';
    }

    // LUK SCANNER - ALTID VIRKER
    window.closeScanner = function() {
      try {
        qrScanning = false;
        if (scanAnimationFrame) {
          cancelAnimationFrame(scanAnimationFrame);
          scanAnimationFrame = null;
        }
        if (qrStream) {
          qrStream.getTracks().forEach(t => t.stop());
          qrStream = null;
        }
      } catch (e) {}
      window.location.href = 'index.html';
    };

    // CONFIG
    function getConfig() {
      if (window.CONFIG) return window.CONFIG;
      if (typeof CONFIG !== 'undefined') {
        window.CONFIG = CONFIG;
        return CONFIG;
      }
      return {
        API_URL: 'https://vinlager-opt-lling-2026.onrender.com',
        TIMEOUT: 60000
      };
    }

    function toLocalDateTimeString() {
      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // API CALL - MED AUTHENTICATION
    async function apiCall(endpoint, options = {}) {
      const config = getConfig();
      const url = `${config.API_URL}${endpoint}`;
      const ac = new AbortController();
      const tid = setTimeout(() => ac.abort(), config.TIMEOUT || 60000);
      
      // KRITISK: Hent auth token fra localStorage
      const token = localStorage.getItem('auth_token') || localStorage.getItem('jwt_token');
      
      console.log(`üåê API kald: ${options.method || 'GET'} ${url}`);
      if (options.body) {
        console.log(`üì¶ Request body:`, options.body);
      }
      if (token) {
        console.log('üîê Auth token fundet');
      } else {
        console.warn('‚ö†Ô∏è Ingen auth token fundet - request kan fejle');
      }
      
      try {
        const headers = {
          'Content-Type': 'application/json',
          ...(options.headers || {})
        };
        
        // Tilf√∏j auth token hvis det findes
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch(url, {
          ...options,
          signal: ac.signal,
          headers: headers
        });
        clearTimeout(tid);
        
        console.log(`üì• Response status: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          // Hvis 401, pr√∏v at hente token fra auth objekt
          if (response.status === 401) {
            console.warn('‚ö†Ô∏è 401 Unauthorized - tjekker auth...');
            // Pr√∏v at hente token fra auth hvis det findes
            if (typeof auth !== 'undefined' && auth && auth.getToken) {
              const authToken = auth.getToken();
              if (authToken && authToken !== token) {
                console.log('üîÑ Pr√∏ver igen med token fra auth objekt');
                headers['Authorization'] = `Bearer ${authToken}`;
                const retryResponse = await fetch(url, {
                  ...options,
                  signal: ac.signal,
                  headers: headers
                });
                if (retryResponse.ok) {
                  const data = await retryResponse.json();
                  return data;
                }
              }
            }
          }
          
          const errorText = await response.text();
          console.error(`‚ùå API fejl ${response.status}:`, errorText);
          throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
        }
        
        const data = await response.json();
        console.log(`‚úÖ API success:`, data);
        return data;
      } catch (e) {
        clearTimeout(tid);
        console.error(`‚ùå API exception:`, e.message);
        throw e;
      }
    }

    // STATUS - FJERNET - ingen status-besked der forstyrrer

    // HENT LOKATIONER
    async function loadLocations() {
      showStatus('Henter lokationer...', 'info', 0);
      
      const select = document.getElementById('location-select');
      if (!select) {
        showStatus('FEJL: Location select ikke fundet', 'error', 5000);
        locationsLoaded = true;
        startQRScannerWhenReady();
        return;
      }
      
      select.innerHTML = '<option value="">Henter lokationer...</option>';
      selectedLocationId = null;
      locationsLoaded = false;
      
      select.onchange = (e) => {
        const value = e.target.value;
        // H√•ndter b√•de id (nummer) og navn (tekst)
        if (value && !isNaN(value)) {
          selectedLocationId = parseInt(value);
        } else {
          selectedLocationId = value; // Gem navn hvis det ikke er et nummer
        }
      };
      
      try {
        showStatus('Henter lokationer...', 'info', 0);
        
        // KRITISK FIX: Brug apiCall() i stedet for fetch() s√• authentication virker!
        let data = [];
        try {
          // Pr√∏v at hente lokationer - selv uden token kan backend v√¶re √•ben
          data = await apiCall('/api/locations');
          console.log('üì¶ Lokationer modtaget fra backend:', data);
          
          // KRITISK: Hvis ingen lokationer, pr√∏v at hente fra produkter
          if (!data || data.length === 0) {
            console.log('‚ö†Ô∏è Ingen lokationer i backend - henter fra produkter...');
            try {
              const products = await apiCall('/api/wines');
              const uniqueLocations = [...new Set((products || []).map(p => p.lokation).filter(Boolean))];
              console.log(`üìã Fundet ${uniqueLocations.length} unikke lokationer fra produkter`);
              
              // Opret lokation objekter fra produkter
              data = uniqueLocations.map((name, index) => {
                const nameLower = name.toLowerCase();
                const category = (nameLower.includes('√∏l') || nameLower.includes('vand') || 
                                 nameLower.includes('bar') || nameLower.includes('k√∏leren')) 
                                 ? '√òl & Vand' : 'Vin';
                return { id: index + 1, name: name, category: category };
              });
            } catch (e) {
              console.warn('‚ö†Ô∏è Kunne ikke hente lokationer fra produkter:', e);
            }
          }
        } catch (apiError) {
          console.error('‚ùå Fejl ved hentning fra backend:', apiError);
          // FALLBACK: Opret standard lokationer hvis backend fejler
          console.log('‚ö†Ô∏è Backend fejler - bruger standard lokationer');
          data = [
            { id: 1, name: 'Restaurant 1', category: 'Vin' },
            { id: 2, name: 'Vinlager', category: 'Vin' },
            { id: 3, name: 'Vink√∏ler', category: 'Vin' },
            { id: 4, name: 'Bar 1', category: '√òl & Vand' },
            { id: 5, name: 'K√∏leren √òl & vand 1', category: '√òl & Vand' },
            { id: 6, name: 'Restaurant 2', category: 'Vin' },
            { id: 7, name: 'K√∏leren √òl & vand 2', category: '√òl & Vand' },
            { id: 8, name: 'Bar 2', category: '√òl & Vand' }
          ];
          showStatus('‚ö†Ô∏è Bruger standard lokationer', 'warning', 3000);
        }
        
        if (Array.isArray(data) && data.length > 0) {
          locations = data;
          select.innerHTML = '<option value="">Alle lokationer</option>';
          
          // KRITISK: Grupp√©r lokationer i "Vinlager" og "√òl & vand"
          const vinLocations = [];
          const olVandLocations = [];
          
          data.forEach(loc => {
            const category = (loc.category || loc.kategori || '').toLowerCase();
            const name = (loc.name || '').toLowerCase();
            
            // Tjek om det er √òl & Vand lokation
            const isOlVand = category.includes('√∏l') || category.includes('vand') || 
                            name.includes('√∏l') || name.includes('vand') || 
                            name.includes('bar') || name.includes('k√∏leren');
            
            if (isOlVand) {
              olVandLocations.push(loc);
            } else {
              vinLocations.push(loc);
            }
          });
          
          // Tilf√∏j "Vinlager" gruppe
          if (vinLocations.length > 0) {
            const optgroupVin = document.createElement('optgroup');
            optgroupVin.label = 'üç∑ Vinlager';
            vinLocations.forEach(loc => {
              const o = document.createElement('option');
              o.value = loc.id || loc.name; // Brug navn hvis ingen id
              o.textContent = loc.name;
              optgroupVin.appendChild(o);
            });
            select.appendChild(optgroupVin);
          }
          
          // Tilf√∏j "√òl & vand" gruppe
          if (olVandLocations.length > 0) {
            const optgroupOlVand = document.createElement('optgroup');
            optgroupOlVand.label = 'üç∫ √òl & vand';
            olVandLocations.forEach(loc => {
              const o = document.createElement('option');
              o.value = loc.id || loc.name; // Brug navn hvis ingen id
              o.textContent = loc.name;
              optgroupOlVand.appendChild(o);
            });
            select.appendChild(optgroupOlVand);
          }
          
          // Hvis ingen gruppering, tilf√∏j alle som normalt
          if (vinLocations.length === 0 && olVandLocations.length === 0) {
            data.forEach(loc => {
              const o = document.createElement('option');
              o.value = loc.id || loc.name;
              o.textContent = loc.name;
              select.appendChild(o);
            });
          }
          
          showStatus(`‚úÖ ${data.length} lokationer klar`, 'success', 2000);
          console.log(`‚úÖ ${data.length} lokationer indl√¶st (${vinLocations.length} Vin, ${olVandLocations.length} √òl & Vand)`);
        } else {
          // FALLBACK: Opret standard lokationer hvis ingen data
          console.log('‚ö†Ô∏è Ingen lokationer - opretter standard lokationer');
          locations = [
            { id: 1, name: 'Restaurant 1', category: 'Vin' },
            { id: 2, name: 'Vinlager', category: 'Vin' },
            { id: 3, name: 'Vink√∏ler', category: 'Vin' },
            { id: 4, name: 'Bar 1', category: '√òl & Vand' },
            { id: 5, name: 'K√∏leren √òl & vand 1', category: '√òl & Vand' },
            { id: 6, name: 'Restaurant 2', category: 'Vin' },
            { id: 7, name: 'K√∏leren √òl & vand 2', category: '√òl & Vand' },
            { id: 8, name: 'Bar 2', category: '√òl & Vand' }
          ];
          select.innerHTML = '<option value="">Alle lokationer</option>';
          
          // Tilf√∏j ogs√• fallback lokationer til dropdown
          const optgroupVin = document.createElement('optgroup');
          optgroupVin.label = 'üç∑ Vinlager';
          locations.filter(l => l.category === 'Vin').forEach(loc => {
            const o = document.createElement('option');
            o.value = loc.id;
            o.textContent = loc.name;
            optgroupVin.appendChild(o);
          });
          select.appendChild(optgroupVin);
          
          const optgroupOlVand = document.createElement('optgroup');
          optgroupOlVand.label = 'üç∫ √òl & vand';
          locations.filter(l => l.category === '√òl & Vand').forEach(loc => {
            const o = document.createElement('option');
            o.value = loc.id;
            o.textContent = loc.name;
            optgroupOlVand.appendChild(o);
          });
          select.appendChild(optgroupOlVand);
          
          // Grupp√©r standard lokationer
          const optgroupVin = document.createElement('optgroup');
          optgroupVin.label = 'üç∑ Vinlager';
          locations.filter(l => l.category === 'Vin').forEach(loc => {
            const o = document.createElement('option');
            o.value = loc.id;
            o.textContent = loc.name;
            optgroupVin.appendChild(o);
          });
          select.appendChild(optgroupVin);
          
          const optgroupOlVand = document.createElement('optgroup');
          optgroupOlVand.label = 'üç∫ √òl & vand';
          locations.filter(l => l.category === '√òl & Vand').forEach(loc => {
            const o = document.createElement('option');
            o.value = loc.id;
            o.textContent = loc.name;
            optgroupOlVand.appendChild(o);
          });
          select.appendChild(optgroupOlVand);
          
          showStatus('‚úÖ Standard lokationer oprettet', 'success', 2000);
        }
        
        locationsLoaded = true;
        setTimeout(() => hideStatus(), 2000);
        
        // Start scanner n√•r lokationer er klar
        startQRScannerWhenReady();
      } catch (e) {
        console.error('‚ùå Fejl ved hentning af lokationer:', e);
        // FALLBACK: Opret standard lokationer ved fejl
        locations = [
          { id: 1, name: 'Restaurant 1', category: 'Vin' },
          { id: 2, name: 'Vinlager', category: 'Vin' },
          { id: 3, name: 'Vink√∏ler', category: 'Vin' },
          { id: 4, name: 'Bar 1', category: '√òl & Vand' },
          { id: 5, name: 'K√∏leren √òl & vand 1', category: '√òl & Vand' }
        ];
        select.innerHTML = '<option value="">Alle lokationer</option>';
        
        // Grupp√©r standard lokationer
        const optgroupVin = document.createElement('optgroup');
        optgroupVin.label = 'üç∑ Vinlager';
        locations.filter(l => l.category === 'Vin').forEach(loc => {
          const o = document.createElement('option');
          o.value = loc.id;
          o.textContent = loc.name;
          optgroupVin.appendChild(o);
        });
        select.appendChild(optgroupVin);
        
        const optgroupOlVand = document.createElement('optgroup');
        optgroupOlVand.label = 'üç∫ √òl & vand';
        locations.filter(l => l.category === '√òl & Vand').forEach(loc => {
          const o = document.createElement('option');
          o.value = loc.id;
          o.textContent = loc.name;
          optgroupOlVand.appendChild(o);
        });
        select.appendChild(optgroupOlVand);
        
        showStatus('‚úÖ Standard lokationer oprettet (fejl h√•ndteret)', 'warning', 3000);
        locationsLoaded = true;
        startQRScannerWhenReady();
      }
    }

    // START SCANNER - VENT P√Ö LOKATIONER
    function startQRScannerWhenReady() {
      console.log('üîç startQRScannerWhenReady() kaldt');
      console.log('  locationsLoaded:', locationsLoaded);
      console.log('  jsQR defineret:', typeof jsQR !== 'undefined');
      
      // Vent maksimalt 10 sekunder p√• lokationer
      let waitCount = 0;
      const maxWait = 20; // 20 * 500ms = 10 sekunder
      
      function checkAndStart() {
        waitCount++;
        console.log(`‚è≥ Tjek ${waitCount}/${maxWait}: locationsLoaded=${locationsLoaded}, jsQR=${typeof jsQR !== 'undefined'}`);
        
        // Hvis lokationer ikke er hentet, vent lidt mere
        if (!locationsLoaded && waitCount < maxWait) {
          setTimeout(checkAndStart, 500);
          return;
        }
        
        // Hvis jsQR ikke er indl√¶st, vent lidt mere
        if (typeof jsQR === 'undefined') {
          if (waitCount < maxWait * 2) {
            console.log(`‚è≥ Venter p√• jsQR bibliotek... (${waitCount}/${maxWait * 2})`);
            setTimeout(checkAndStart, 500);
            return;
          } else {
            console.error('‚ùå jsQR bibliotek ikke indl√¶st efter lang ventetid');
            showStatus('FEJL: Scanner bibliotek ikke indl√¶st. Genindl√¶s siden.', 'error', 0);
            return;
          }
        }
        
        // Nu kan vi starte scanneren
        console.log('‚úÖ Starter scanner - lokationer og bibliotek er klar');
        startQRScanner();
      }
      
      checkAndStart();
    }
    
    // START SCANNER
    async function startQRScanner() {
      console.log('üöÄ startQRScanner() kaldt');
      
      if (qrScanning) {
        console.log('‚ö†Ô∏è Scanner k√∏rer allerede - ignorerer');
        return;
      }
      
      // Cache video og canvas elementer
      video = document.getElementById('qr-video');
      canvas = document.getElementById('qr-canvas');
      
      if (!video) {
        console.error('‚ùå Video element ikke fundet!');
        showStatus('FEJL: Video element ikke fundet', 'error', 0);
        return;
      }
      
      if (!canvas) {
        console.error('‚ùå Canvas element ikke fundet!');
        showStatus('FEJL: Canvas element ikke fundet', 'error', 0);
        return;
      }
      
      console.log('‚úÖ Video og canvas elementer fundet');
      
      try {
        showStatus('Anmoder om kamera adgang...', 'info', 0);
        
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        
        qrStream = stream;
        video.srcObject = stream;
        qrScanning = true;
        
        console.log('‚úÖ Kamera stream tildelt, qrScanning = true');
        
        // Start scanning n√•r video er klar
        const startScanning = () => {
          console.log('üîç startScanning() kaldt');
          console.log('  qrScanning:', qrScanning);
          console.log('  video:', !!video);
          console.log('  video.srcObject:', !!video?.srcObject);
          console.log('  video.readyState:', video?.readyState);
          console.log('  jsQR defineret:', typeof jsQR !== 'undefined');
          
          if (!qrScanning) {
            console.warn('‚ö†Ô∏è qrScanning er false - kan ikke starte');
            return;
          }
          
          if (!video) {
            console.error('‚ùå Video element mangler');
            return;
          }
          
          if (!video.srcObject) {
            console.warn('‚ö†Ô∏è Video stream mangler - venter...');
            setTimeout(startScanning, 500);
            return;
          }
          
          if (typeof jsQR === 'undefined') {
            console.warn('‚ö†Ô∏è jsQR ikke defineret - venter...');
            setTimeout(startScanning, 500);
            return;
          }
          
          console.log('‚úÖ Starter scanFrame()...');
          if (scanAnimationFrame) {
            cancelAnimationFrame(scanAnimationFrame);
            scanAnimationFrame = null;
          }
          scanFrame();
        };
        
        // FALLBACK: Start scanning n√•r metadata er klar
        video.onloadedmetadata = () => {
          console.log('‚úÖ Video metadata klar, readyState:', video.readyState);
          showStatus('Kamera klar - starter scanning...', 'success', 2000);
          video.play().then(() => {
            console.log('‚úÖ Video afspiller');
            hideStatus();
            startScanning();
          }).catch(err => {
            console.error('‚ùå Fejl ved afspilning i onloadedmetadata:', err);
            showStatus(`FEJL ved afspilning: ${err.message}`, 'error', 5000);
          });
        };
        
        // Pr√∏v at afspille med det samme
        video.play().then(() => {
          console.log('‚úÖ Video afspiller (direkte)');
          hideStatus();
          startScanning();
        }).catch(err => {
          console.error('‚ùå Fejl ved direkte afspilning:', err);
          showStatus(`FEJL ved afspilning: ${err.message}`, 'error', 5000);
        });
        
        // FALLBACK: Start scanning efter kort ventetid
        setTimeout(() => {
          if (qrScanning && video && video.srcObject) {
            if (video.readyState >= 2) {
              console.log('‚úÖ Fallback: Starter scanFrame() efter timeout, readyState:', video.readyState);
              startScanning();
            } else {
              console.warn('‚ö†Ô∏è Video ikke klar endnu, readyState:', video.readyState);
            }
          } else {
            console.warn('‚ö†Ô∏è Scanner ikke klar efter timeout');
          }
        }, 1500);
        
      } catch (error) {
        qrScanning = false;
        let errorMsg = 'Kunne ikke f√• adgang til kamera.';
        if (error.name === 'NotAllowedError') {
          errorMsg = 'Kamera adgang n√¶gtet. Tjek browser indstillinger.';
        } else if (error.name === 'NotFoundError') {
          errorMsg = 'Ingen kamera fundet.';
        } else if (error.name === 'NotReadableError') {
          errorMsg = 'Kamera er optaget af andet program.';
        } else {
          errorMsg = `Kamera fejl: ${error.message}`;
        }
        showStatus(errorMsg, 'error', 0);
      }
    }
    
    // SCAN FRAME - MED DEBOUNCE OG VALIDERING
    function scanFrame() {
      // KRITISK: Tjek om scanning stadig er aktiv
      if (!qrScanning) {
        console.log('‚ö†Ô∏è qrScanning er false - stopper scanning');
        if (scanAnimationFrame) {
          cancelAnimationFrame(scanAnimationFrame);
          scanAnimationFrame = null;
        }
        return;
      }
      
      // KRITISK: Hent video element hvis det ikke er cached
      if (!video) {
        video = document.getElementById('qr-video');
      }
      
      if (!video) {
        console.error('‚ùå video element ikke fundet');
        qrScanning = false;
        return;
      }
      
      // KRITISK: Hent canvas element hvis det ikke er cached
      if (!canvas) {
        canvas = document.getElementById('qr-canvas');
      }
      
      if (!canvas) {
        console.error('‚ùå canvas element ikke fundet');
        qrScanning = false;
        return;
      }
      
      // Tjek om video er klar
      if (video.readyState < video.HAVE_METADATA) {
        // Video ikke klar endnu - pr√∏v igen snart
        scanAnimationFrame = requestAnimationFrame(scanFrame);
        return;
      }
      
      if (video.readyState < video.HAVE_ENOUGH_DATA) {
        // Video har ikke nok data endnu
        scanAnimationFrame = requestAnimationFrame(scanFrame);
        return;
      }
      
      try {
        const width = video.videoWidth;
        const height = video.videoHeight;
        if (!width || !height || width === 0 || height === 0) {
          // Video dimensioner ikke klar endnu
          scanAnimationFrame = requestAnimationFrame(scanFrame);
          return;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, width, height);
        const imageData = ctx.getImageData(0, 0, width, height);
        
        if (typeof jsQR === 'undefined') {
          console.warn('‚ö†Ô∏è jsQR ikke defineret - venter...');
          scanAnimationFrame = requestAnimationFrame(scanFrame);
          return;
        }
        
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code && code.data && code.data.trim()) {
          const codeData = code.data.trim();
          
          // VALIDERING: Tjek om QR-koden ser gyldig ud
          // Accepter b√•de VIN-XXXX format og WXXX format (varenummer)
          const isValidFormat = /^(VIN-|W\d+|vin-|w\d+)/i.test(codeData);
          
          if (!isValidFormat) {
            // Ignorer falske QR-koder fra st√∏j
            scanAnimationFrame = requestAnimationFrame(scanFrame);
            return;
          }
          
          // DEBOUNCE: Ignorer samme kode hvis den scannes for hurtigt (inden for 2 sekunder)
          const now = Date.now();
          if (codeData === lastScannedCode && (now - lastScanTime) < 2000) {
            // Samme kode scannet for hurtigt - ignorer
            scanAnimationFrame = requestAnimationFrame(scanFrame);
            return;
          }
          
          // Ny kode eller nok tid er g√•et - behandle scan
          lastScannedCode = codeData;
          lastScanTime = now;
          console.log('üì∑ QR-kode scannet:', codeData);
          
          // Behandle scan, men forts√¶t scanning
          handleScan(codeData);
          
          // Forts√¶t scanning - ikke stop
          scanAnimationFrame = requestAnimationFrame(scanFrame);
          return;
        }
      } catch (err) {
        console.error('‚ùå Scan fejl:', err);
        // Forts√¶t scanning selv ved fejl
      }
      
      // Forts√¶t scanning - ALTID hvis qrScanning er true
      if (qrScanning) {
        scanAnimationFrame = requestAnimationFrame(scanFrame);
      } else {
        console.log('‚ö†Ô∏è qrScanning er false - stopper scan loop');
        if (scanAnimationFrame) {
          cancelAnimationFrame(scanAnimationFrame);
          scanAnimationFrame = null;
        }
      }
    }

    // H√ÖNDTER SCAN
    async function handleScan(codeData) {
      // KRITISK FIX: Scanner skal h√•ndtere b√•de VIN og √òl & Vand
      // Tjek om det er VIN (starter med VIN-) eller √òl & Vand (starter med OL- eller W)
      const isOlVand = codeData.startsWith('OL-') || /^W\d{4,}$/.test(codeData);
      if (!codeData || !codeData.trim()) {
        console.warn('‚ö†Ô∏è Tom eller ugyldig QR-kode');
        return;
      }
      
      const modal = document.getElementById('quantity-modal');
      if (modal && modal.classList.contains('show')) {
        console.log('‚ö†Ô∏è Modal allerede √•ben - ignorerer scan');
        return;
      }
      
      const trimmedCode = codeData.trim();
      console.log(`üîç S√∏ger efter vin med kode: "${trimmedCode}"`);
      showStatus('S√∏ger efter vin...', 'info', 2000);
      
      try {
        // Pr√∏v f√∏rst med VIN-ID direkte
        let wine = null;
        let foundMethod = '';
        
        try {
          console.log(`üì§ Pr√∏ver /api/wines/${encodeURIComponent(trimmedCode)}`);
          wine = await apiCall(`/api/wines/${encodeURIComponent(trimmedCode)}`);
          foundMethod = '/api/wines/:id';
          console.log('‚úÖ Vin fundet via /api/wines/:id:', wine);
        } catch (e1) {
          console.warn('‚ö†Ô∏è Fejl ved /api/wines/:id:', e1.message);
          // Fallback: Pr√∏v med barcode endpoint
          try {
            console.log(`üì§ Pr√∏ver /api/wines/barcode/${encodeURIComponent(trimmedCode)}`);
            wine = await apiCall(`/api/wines/barcode/${encodeURIComponent(trimmedCode)}`);
            foundMethod = '/api/wines/barcode/:barcode';
            console.log('‚úÖ Vin fundet via /api/wines/barcode/:barcode:', wine);
          } catch (e2) {
            console.warn('‚ö†Ô∏è Fejl ved /api/wines/barcode/:barcode:', e2.message);
            // Sidste fallback: Hent alle wines og s√∏g manuelt
            try {
              console.log('üì§ Henter alle wines for manuel s√∏gning...');
              const allWines = await apiCall('/api/wines');
              console.log(`üì¶ Modtaget ${allWines ? allWines.length : 0} vine`);
              
              if (Array.isArray(allWines) && allWines.length > 0) {
                wine = allWines.find(w => {
                  // KRITISK: Tjek ogs√• kategori for at skelne mellem Vin og √òl & Vand
                  const kategori = (w.kategori || w.type || '').toLowerCase();
                  const isWineOlVand = kategori.includes('√∏l') || kategori.includes('vand') || kategori.includes('sodavand') ||
                                       (w.vinId && w.vinId.toString().toLowerCase().startsWith('ol-')) ||
                                       /^w\d{4,}$/i.test(w.vinId || '');
                  
                  // Match kun hvis kategori matcher
                  if (isOlVand && !isWineOlVand) return false;
                  if (!isOlVand && isWineOlVand) return false;
                  
                  const matches = 
                    (w.vinId && w.vinId.toString() === trimmedCode) ||
                    (w.varenummer && w.varenummer.toString() === trimmedCode) ||
                    (w.barcode && w.barcode.toString() === trimmedCode);
                  if (matches) {
                    console.log('‚úÖ Match fundet:', w);
                  }
                  return matches;
                });
                
                if (wine) {
                  foundMethod = 'manuel s√∏gning i alle wines';
                  console.log('‚úÖ Vin fundet i alle wines:', wine);
                } else {
                  console.warn('‚ö†Ô∏è Vin ikke fundet i alle wines');
                  console.log('  S√∏gte efter:', trimmedCode);
                  console.log('  Eksempel vine:', allWines.slice(0, 3).map(w => ({
                    vinId: w.vinId,
                    varenummer: w.varenummer,
                    barcode: w.barcode
                  })));
                }
              } else {
                console.warn('‚ö†Ô∏è Ingen vine modtaget fra backend');
              }
            } catch (e3) {
              console.error('‚ùå Alle metoder fejlede:', e3);
              console.error('  e1:', e1.message);
              console.error('  e2:', e2.message);
              console.error('  e3:', e3.message);
            }
          }
        }
        
        if (wine && wine.vinId) {
          console.log(`‚úÖ ${productType} fundet via ${foundMethod}:`, wine.vinId, wine.navn);
          showStatus(`${productType} fundet!`, 'success', 1000);
          showQuantityModal(wine, false);
        } else {
          console.warn(`‚ö†Ô∏è ${productType} ikke fundet - viser "Ukendt vare" modal`);
          showStatus(`${productType} ikke fundet`, 'warning', 2000);
          showQuantityModal({ vinId: trimmedCode, navn: 'Ukendt vare', kategori: isOlVand ? '√òl & Vand' : 'Vin' }, true);
        }
      } catch (error) {
        console.error('‚ùå KRITISK FEJL i handleScan:', error);
        console.error('  Error stack:', error.stack);
        showStatus('Fejl ved s√∏gning', 'error', 2000);
        showQuantityModal({ vinId: trimmedCode, navn: 'Ukendt vare' }, true);
      }
    }

    // VIS MODAL
    function showQuantityModal(wine, notFound) {
      const modal = document.getElementById('quantity-modal');
      const title = document.getElementById('modal-title');
      const warning = document.getElementById('modal-warning');
      const info = document.getElementById('modal-info');
      const input = document.getElementById('quantity-input');
      
      currentWine = wine;
      
      if (notFound) {
        title.textContent = 'Indtast antal';
        warning.style.display = 'flex';
        info.innerHTML = `<div><strong>Stregkode:</strong> ${wine.vinId}</div>`;
        input.value = '1';
      } else {
        title.textContent = wine.navn || 'Indtast antal';
        warning.style.display = 'none';
        const locName = selectedLocationId ? (locations.find(l => l.id === selectedLocationId || l.name === selectedLocationId)?.name || selectedLocationId) : 'Ikke valgt';
        info.innerHTML = `
          <div><strong>VIN-ID:</strong> ${wine.vinId}</div>
          <div><strong>Lokation:</strong> ${locName}</div>
          <div><strong>Nuv√¶rende:</strong> ${wine.antal || 0}</div>
        `;
        input.value = wine.antal || '1';
      }
      
      modal.classList.add('show');
      input.focus();
      input.select();
    }

    function closeModal() {
      const modal = document.getElementById('quantity-modal');
      modal.classList.remove('show');
      currentWine = null;
    }

    // GEM ANTAL
    async function saveQuantity() {
      const input = document.getElementById('quantity-input');
      const quantity = parseInt(input.value) || 0;
      
      if (!currentWine || !currentWine.vinId) {
        alert('Ingen vin valgt!');
        closeModal();
        return;
      }
      
      console.log(`üíæ Gemmer antal for ${currentWine.vinId}: ${quantity}`);
      
      try {
        // KRITISK FIX: GEM ALTID data til backend, uanset om vinen findes eller ej
        if (currentWine.vinId) {
          try {
            // KRITISK FIX: Hvis ingen lokation er valgt, brug f√∏rste tilg√¶ngelige lokation
            let finalLocationId = selectedLocationId ? parseInt(selectedLocationId) : null;
            if (!finalLocationId && locations.length > 0) {
              finalLocationId = locations[0].id;
              console.log(`‚ö†Ô∏è Ingen lokation valgt, bruger f√∏rste tilg√¶ngelige: ${finalLocationId} (${locations[0].name})`);
            }
            
            const requestBody = {
              nytAntal: quantity,
              locationId: finalLocationId
            };
            
            console.log(`üì§ Sender til backend: /api/count/${currentWine.vinId}`, requestBody);
            
            // KRITISK FIX: Send nytAntal som tal, ikke string
            const response = await apiCall(`/api/count/${currentWine.vinId}`, {
              method: 'POST',
              body: JSON.stringify(requestBody)
            });
            
            console.log('‚úÖ Backend respons:', response);
            
            // Opdater currentWine med det nye antal fra backend
            if (response && response.nytAntal !== undefined) {
              currentWine.antal = response.nytAntal;
              console.log(`‚úÖ Antal opdateret i backend til: ${response.nytAntal}`);
            } else {
              // Hvis backend ikke returnerer nytAntal, brug det vi sendte
              currentWine.antal = quantity;
              console.log(`‚úÖ Brugt sendt antal: ${quantity}`);
            }
          } catch (apiError) {
            console.error('‚ùå Fejl ved API kald:', apiError);
            console.error('‚ùå Fejl detaljer:', apiError.message, apiError.stack);
            // Hvis API fejler, gem stadig lokalt for rapporten
            console.warn('‚ö†Ô∏è API fejlede, gemmer lokalt for rapporten');
            currentWine.antal = quantity;
            // Vis ikke alert - forstyrrer scanning
          }
        }
        
        // Brug samme locationId som blev sendt til backend
        // H√•ndter b√•de id (nummer) og navn (tekst)
        let finalLocationId = null;
        if (selectedLocationId) {
          if (!isNaN(selectedLocationId)) {
            finalLocationId = parseInt(selectedLocationId);
          } else {
            // Hvis det er et navn, find id eller brug navnet
            const loc = locations.find(l => l.name === selectedLocationId);
            finalLocationId = loc ? (loc.id || loc.name) : selectedLocationId;
          }
        } else if (locations.length > 0) {
          finalLocationId = locations[0].id || locations[0].name;
        }
        const locName = finalLocationId ? locations.find(l => l.id === finalLocationId)?.name : 'Ikke valgt';
        scannedWines.set(currentWine.vinId, {
          ...currentWine,
          antal: currentWine.antal || quantity,
          locationId: finalLocationId,
          locationName: locName
        });
        
        console.log(`‚úÖ Gemt i scannedWines: ${currentWine.vinId}, antal: ${currentWine.antal || quantity}, total scannet: ${scannedWines.size}`);
        
        // Ingen status-besked - forstyrrer scanning
        closeModal();
      } catch (error) {
        console.error('‚ùå KRITISK FEJL ved gemning af antal:', error);
        console.error('‚ùå Fejl stack:', error.stack);
        alert(`Fejl: ${error.message}`);
      }
    }

    // AFSLUT OPT√ÜLLING
    async function finishCounting() {
      if (scannedWines.size === 0) {
        if (!confirm('Ingen vine scannet. Afslutte?')) return;
      } else {
        const locName = selectedLocationId ? (locations.find(l => l.id === selectedLocationId || l.name === selectedLocationId)?.name || selectedLocationId) : 'Ikke valgt';
        if (!confirm(`${scannedWines.size} vine scannet. Lokation: ${locName}. Afslutte?`)) return;
      }
      
      try {
        // Ingen status-besked - forstyrrer ikke
        
        if (qrStream) {
          qrStream.getTracks().forEach(t => t.stop());
          qrStream = null;
        }
        qrScanning = false;
        
        const wines = Array.from(scannedWines.values());
        if (wines.length === 0) {
          alert('Ingen vine scannet.');
          return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;
        doc.setFontSize(16);
        doc.text('Opt√¶llingsrapport', 14, y);
        y += 10;
        
        const winesByLocation = {};
        wines.forEach(w => {
          const loc = w.locationName || 'Ikke valgt';
          if (!winesByLocation[loc]) winesByLocation[loc] = [];
          winesByLocation[loc].push(w);
        });
        
        let grandTotal = 0;
        let grandCount = 0;
        
        Object.keys(winesByLocation).sort().forEach(loc => {
          if (y > 250) { doc.addPage(); y = 20; }
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text(`Lokation: ${loc}`, 14, y);
          y += 8;
          
          doc.setFontSize(8);
          doc.setFont(undefined, 'normal');
          winesByLocation[loc].forEach(w => {
            if (y > 280) { doc.addPage(); y = 20; }
            const pris = w.indk√∏bspris || 0;
            const v√¶rdi = pris * (w.antal || 0);
            grandTotal += v√¶rdi;
            grandCount++;
            doc.setFont(undefined, 'bold');
            const varenummer = w.varenummer || w.vinId || '';
            doc.text(`* ${varenummer} | ${w.navn || ''} | ${w.antal || 0} | ${pris.toFixed(2)} kr`, 14, y);
            doc.setFont(undefined, 'normal');
            y += 6;
          });
          y += 5;
        });
        
        if (y > 270) { doc.addPage(); y = 20; }
        y += 5;
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(`SAMLET TOTAL: ${grandCount} vine, ${grandTotal.toFixed(2)} kr.`, 14, y);
        
        const locName = selectedLocationId ? (locations.find(l => l.id === selectedLocationId || l.name === selectedLocationId)?.name || selectedLocationId) : 'Alle lokationer';
        const reportData = {
          reportId: Date.now().toString(),
          date: toLocalDateTimeString(),
          name: 'OPT√ÜLLING-' + Date.now().toString().slice(-6),
          type: 'lager',
          wineCount: grandCount,
          totalValue: grandTotal,
          location: locName,
          archived: false
        };
        
        // KRITISK: Gem i localStorage F√òRST (sikker backup)
        try {
          const saved = localStorage.getItem('reportsHistory');
          let existingReports = [];
          if (saved) {
            try {
              existingReports = JSON.parse(saved);
              if (!Array.isArray(existingReports)) {
                existingReports = [];
              }
            } catch (e) {
              existingReports = [];
            }
          }
          
          const reportForStorage = {
            id: reportData.reportId,
            date: reportData.date,
            name: reportData.name,
            type: reportData.type,
            wineCount: reportData.wineCount,
            totalValue: reportData.totalValue,
            location: reportData.location,
            archived: reportData.archived
          };
          
          existingReports.unshift(reportForStorage);
          if (existingReports.length > 200) {
            existingReports = existingReports.slice(0, 200);
          }
          
          localStorage.setItem('reportsHistory', JSON.stringify(existingReports));
          console.log('‚úÖ Rapport gemt i localStorage backup');
        } catch (storageError) {
          console.error('‚ùå Fejl ved gemning i localStorage:', storageError);
        }
        
        // Pr√∏v at gemme i backend (men forts√¶t selv hvis det fejler)
        try {
          await apiCall('/api/reports/save', {
            method: 'POST',
            body: JSON.stringify(reportData)
          });
          console.log('‚úÖ Rapport gemt i backend');
        } catch (e) {
          console.warn('‚ö†Ô∏è Kunne ikke gemme i backend (forts√¶tter alligevel):', e);
          // Forts√¶t alligevel - vi har gemt i localStorage
        }
        
        doc.save('lagerrapport_opt√¶lling.pdf');
        
        setTimeout(() => {
          alert(`Opt√¶lling afsluttet! ${grandCount} vine, ${grandTotal.toFixed(2)} kr.`);
          window.location.href = 'index.html';
        }, 1000);
      } catch (error) {
        console.error('Fejl:', error.message);
      }
    }

    // START ALT
    function start() {
      console.log('üöÄ Starter scanner applikation...');
      // Hent lokationer f√∏rst - scanneren starter automatisk n√•r de er klar
      loadLocations();
      
      const input = document.getElementById('quantity-input');
      if (input) {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') saveQuantity();
        });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', start);
    } else {
      start();
    }
  </script>
</body>
</html>
